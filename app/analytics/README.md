# Микросервис прогностической аналитики успеваемости студентов

Этот микросервис предоставляет функционал для анализа и прогнозирования успеваемости студентов с использованием нейронных сетей (LSTM/Transformer).

## Содержание

- [Технологии](#технологии)
- [Установка и запуск](#установка-и-запуск)
- [Структура проекта](#структура-проекта)
- [API Reference](#api-reference)
- [Работа с Postman](#работа-с-postman)
- [Примеры запросов](#примеры-запросов)

## Технологии

- **Python 3.10+**
- **FastAPI** - современный веб-фреймворк для создания API
- **PyTorch** - библиотека для машинного обучения
- **SQLAlchemy** - ORM для работы с базой данных
- **PostgreSQL** - реляционная база данных
- **Docker** - контейнеризация приложения

## Установка и запуск

### С использованием Docker (рекомендуется)

1. Убедитесь, что у вас установлен Docker и docker-compose
2. Запустите сервис с помощью команды:

```bash
docker-compose build analytics_api
docker-compose up -d analytics_api
```

### Локальная установка (для разработки)

1. Создайте виртуальное окружение Python и активируйте его:

```bash
python -m venv venv
source venv/bin/activate  # для Linux/MacOS
venv\Scripts\activate     # для Windows
```

2. Установите зависимости:

```bash
pip install -r requirements.txt
```

3. Запустите сервер:

```bash
python app/analytics/cmd/server/main.py
```

## Структура проекта

```
app/analytics/
├── api/                # API эндпоинты
│   └── routes.py       # Маршруты FastAPI
├── cmd/                # Точки входа
│   └── server/         # Сервер
│       └── main.py     # Запуск сервера
├── config/             # Конфигурация
│   └── config.py       # Настройки подключения к БД и сервера
├── ml/                 # Модели машинного обучения
│   └── models.py       # Реализация LSTM и Transformer моделей
└── models/             # Модели данных
    └── models.py       # SQLAlchemy модели
```

## API Reference

### Информация о сервисе

- `GET /` - Проверка работоспособности API
- `GET /health` - Проверка состояния сервиса

### Синхронизация данных

- `GET /sync-students` - Синхронизация данных студентов из основной БД
- `GET /sync-grades` - Синхронизация оценок из основной БД

### Модели и прогнозы

- `POST /train-model` - Обучение новой модели прогнозирования
- `GET /models` - Получение списка доступных моделей
- `POST /predict/{model_id}/{student_id}` - Прогнозирование успеваемости студента
- `GET /predictions/student/{student_id}` - Получение истории прогнозов для студента

### Аналитика

- `GET /analytics/group/{group_name}` - Аналитика по группе студентов

## Работа с Postman

Для удобства тестирования API можно использовать Postman. Ниже приведены инструкции по настройке и использованию коллекции запросов.

### Настройка Postman

1. **Создание новой коллекции**:
   - Откройте Postman и создайте новую коллекцию (New > Collection)
   - Назовите коллекцию "Аналитика успеваемости API"

2. **Настройка переменных окружения**:
   - Создайте новое окружение (Environment)
   - Добавьте переменную `base_url` со значением `http://localhost:8085` для локального тестирования или вашим доменным именем в продакшене

### Рекомендуемый порядок запросов

Для корректной работы с сервисом аналитики следуйте данному порядку запросов:

1. **Проверка доступности** (`GET /health`)
2. **Синхронизация данных**:
   - Сначала синхронизируйте студентов (`GET /sync-students`)
   - Затем синхронизируйте оценки (`GET /sync-grades`)
3. **Обучение модели** (`POST /train-model`)
4. **Получение списка моделей** (`GET /models`)
5. **Прогнозирование успеваемости** (`POST /predict/{model_id}/{student_id}`)
6. **Получение аналитики** (`GET /analytics/group/{group_name}`)

## Примеры запросов

Ниже приведены примеры запросов для Postman с настройками и ожидаемыми ответами.

### 1. Проверка состояния сервиса

**Запрос**:
- **Метод**: GET
- **URL**: `{{base_url}}/health`

**Ожидаемый ответ**:
```json
{
  "status": "healthy",
  "timestamp": "2025-07-03T14:25:30.123456"
}
```

### 2. Синхронизация студентов

**Запрос**:
- **Метод**: GET
- **URL**: `{{base_url}}/sync-students`

**Ожидаемый ответ**:
```json
{
  "message": "Синхронизировано X новых студентов"
}
```

### 3. Синхронизация оценок

**Запрос**:
- **Метод**: GET
- **URL**: `{{base_url}}/sync-grades`

**Ожидаемый ответ**:
```json
{
  "message": "Синхронизировано X новых оценок"
}
```

### 4. Обучение модели

**Запрос**:
- **Метод**: POST
- **URL**: `{{base_url}}/train-model`
- **Query параметры**:
  - `model_type`: "lstm" (или "transformer")
  - `subject`: "Математика" (опционально)

**Ожидаемый ответ**:
```json
{
  "message": "Запущен процесс обучения модели",
  "model_type": "lstm",
  "subject": "Математика"
}
```

### 5. Получение списка моделей

**Запрос**:
- **Метод**: GET
- **URL**: `{{base_url}}/models`

**Ожидаемый ответ**:
```json
[
  {
    "id": 1,
    "name": "lstm_model_20250703_142530",
    "description": "Модель LSTM для прогнозирования успеваемости",
    "model_type": "lstm",
    "created_at": "2025-07-03T14:25:30.123456",
    "accuracy": 0.87
  }
]
```

### 6. Прогнозирование успеваемости

**Запрос**:
- **Метод**: POST
- **URL**: `{{base_url}}/predict/1/5`
- **Query параметры**:
  - `subject`: "Математика"

**Ожидаемый ответ**:
```json
{
  "student_id": 5,
  "student_name": "Иванов Иван Иванович",
  "subject": "Математика",
  "predicted_grade": 4.7,
  "confidence": 0.9,
  "prediction_id": 1
}
```

### 7. Получение прогнозов для студента

**Запрос**:
- **Метод**: GET
- **URL**: `{{base_url}}/predictions/student/5`
- **Query параметры**:
  - `subject`: "Математика" (опционально)

**Ожидаемый ответ**:
```json
[
  {
    "id": 1,
    "subject": "Математика",
    "predicted_grade": 4.7,
    "confidence": 0.9,
    "created_at": "2025-07-03T14:30:45.123456",
    "model_id": 1,
    "model_type": "lstm"
  }
]
```

### 8. Получение аналитики по группе

**Запрос**:
- **Метод**: GET
- **URL**: `{{base_url}}/analytics/group/ПИ-101`
- **Query параметры**:
  - `subject`: "Математика" (опционально)

**Ожидаемый ответ**:
```json
{
  "group_name": "ПИ-101",
  "subject": "Математика",
  "students_count": 25,
  "group_avg_grade": 4.3,
  "students": [
    {
      "student_id": 5,
      "student_name": "Иванов Иван Иванович",
      "grades_count": 8,
      "avg_grade": 4.5,
      "max_grade": 5,
      "min_grade": 4,
      "predicted_grade": 4.7
    },
    // ... другие студенты ...
  ]
}
```

## Советы по использованию

1. **Перед обучением модели** убедитесь, что данные синхронизированы
2. **Для обучения модели** требуется минимум 5 оценок для каждого студента по каждому предмету
3. **При прогнозировании** указывайте идентификатор существующей модели и студента
4. **Для аналитики группы** используйте точное название группы, включая регистр

## Устранение неполадок

- **Проблемы с подключением**: убедитесь, что микросервис запущен и доступен
- **Ошибки синхронизации**: проверьте подключение к основной базе данных
- **Недостаточно данных для обучения**: добавьте больше оценок для студентов
- **Ошибки прогнозирования**: убедитесь, что модель обучена и имеет положительную точность

## Дополнительная информация

Дополнительную информацию о моделях прогнозирования и API можно получить в документации FastAPI, доступной по URL:

```
http://localhost:8085/docs
```

или

```
http://localhost:8085/redoc
```
